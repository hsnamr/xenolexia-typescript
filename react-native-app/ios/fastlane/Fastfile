# Xenolexia iOS Fastlane Configuration
# https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  # ==================
  # Before All
  # ==================
  before_all do
    setup_ci if ENV['CI']
  end

  # ==================
  # Testing
  # ==================
  desc "Run tests"
  lane :test do
    run_tests(
      workspace: "Xenolexia.xcworkspace",
      scheme: "Xenolexia",
      device: "iPhone 15",
      code_coverage: true
    )
  end

  # ==================
  # Code Signing
  # ==================
  desc "Sync development certificates and profiles"
  lane :sync_dev do
    match(type: "development", readonly: true)
  end

  desc "Sync App Store certificates and profiles"
  lane :sync_appstore do
    match(type: "appstore", readonly: true)
  end

  # ==================
  # Building
  # ==================
  desc "Build development app"
  lane :build_dev do
    sync_dev
    build_app(
      workspace: "Xenolexia.xcworkspace",
      scheme: "Xenolexia",
      configuration: "Debug",
      export_method: "development"
    )
  end

  desc "Build release app"
  lane :build_release do
    sync_appstore
    
    # Increment build number
    increment_build_number(
      build_number: ENV['BUILD_NUMBER'] || latest_testflight_build_number + 1
    )
    
    build_app(
      workspace: "Xenolexia.xcworkspace",
      scheme: "Xenolexia",
      configuration: "Release",
      export_method: "app-store",
      include_bitcode: false
    )
  end

  # ==================
  # Deployment
  # ==================
  desc "Upload to TestFlight"
  lane :upload_testflight do
    build_release unless lane_context[SharedValues::IPA_OUTPUT_PATH]
    
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: changelog_from_git_commits(
        commits_count: 10,
        pretty: "- %s"
      )
    )
  end

  desc "Deploy to App Store"
  lane :deploy_appstore do
    build_release unless lane_context[SharedValues::IPA_OUTPUT_PATH]
    
    upload_to_app_store(
      force: true,
      submit_for_review: false,
      automatic_release: false,
      precheck_include_in_app_purchases: false
    )
  end

  # ==================
  # Screenshots
  # ==================
  desc "Capture screenshots"
  lane :screenshots do
    capture_screenshots(
      workspace: "Xenolexia.xcworkspace",
      scheme: "XenolexiaUITests"
    )
  end

  desc "Upload screenshots to App Store"
  lane :upload_screenshots do
    upload_to_app_store(
      skip_binary_upload: true,
      skip_metadata: true
    )
  end

  # ==================
  # Utility
  # ==================
  desc "Bump version number"
  lane :bump_version do |options|
    increment_version_number(
      bump_type: options[:type] || "patch" # major, minor, patch
    )
  end

  desc "Clean build artifacts"
  lane :clean do
    clear_derived_data
    sh("rm -rf ../build")
  end

  # ==================
  # After All
  # ==================
  after_all do |lane|
    # Clean up if needed
  end

  error do |lane, exception|
    # Handle errors
    UI.error("Lane #{lane} failed: #{exception.message}")
  end
end
